<!DOCTYPE html>
<html>
<head>
    <title>AI Product Scanner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="edge-impulse-standalone.js"></script>
    <script src="run-impulse.js"></script>
    <style>
        body { font-family: sans-serif; background: #000; color: white; text-align: center; margin: 0; }
        #camera { width: 100%; height: 50vh; object-fit: cover; border-bottom: 2px solid #4CAF50; }
        #status-bar { background: #1a1a1a; padding: 15px; border-bottom: 1px solid #333; }
        #brain-monitor { font-size: 0.8rem; color: #888; font-family: monospace; margin-top: 5px; }
        .highlight { color: #fbff00; font-weight: bold; }
        #log { padding: 20px; text-align: left; height: 40vh; overflow-y: auto; background: #000; }
        .item { background: #1a1a1a; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; border-left: 4px solid #4CAF50; }
        .flash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; z-index: 100; transition: opacity 0.1s; }
    </style>
</head>
<body>
    <div id="flash-effect" class="flash"></div>
    <video id="camera" autoplay playsinline muted></video>
    
    <div id="status-bar">
        <div id="main-status" style="color: #4CAF50; font-weight: bold;">INITIALIZING ENGINE...</div>
        <div id="brain-monitor">AI THINKING: <span id="thinking-text">...</span></div>
    </div>
    
    <div id="log"><div id="item-list"></div></div>

    <canvas id="hiddenCanvas" width="160" height="160" style="display:none;"></canvas>

    <script>
    // FIX: This stops the hardware error from your console screenshot
    window.navigator.hardwareConcurrency = window.navigator.hardwareConcurrency || 4;

    let lastItem = ""; 
    let isPaused = false;

    async function startApp() {
        const video = document.getElementById('camera');
        const mainStatus = document.getElementById('main-status');
        const thinkingText = document.getElementById('thinking-text');
        const canvas = document.getElementById('hiddenCanvas');
        const ctx = canvas.getContext('2d');

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = stream;

            const classifier = new EdgeImpulseClassifier();
            await classifier.init();
            mainStatus.innerText = "READY: SCAN PRODUCT";

            async function processFrame() {
                if (!isPaused && video.readyState === video.HAVE_ENOUGH_DATA) {
                    ctx.drawImage(video, 0, 0, 160, 160);
                    const imgData = ctx.getImageData(0, 0, 160, 160).data;
                    
                    // Convert RGBA to RGB (The AI needs 3 channels, not 4)
                    const pixels = [];
                    for (let i = 0; i < imgData.length; i += 4) {
                        pixels.push(imgData[i], imgData[i+1], imgData[i+2]);
                    }

                    const result = await classifier.classify(pixels);
                    
                    if (result.results && result.results.length > 0) {
                        // Find the highest confidence result
                        let top = result.results.reduce((a, b) => a.value > b.value ? a : b);
                        let label = top.label.toUpperCase();
                        let score = (top.value * 100).toFixed(0);

                        // Update the UI so you can see what the AI thinks
                        thinkingText.innerHTML = `Seeing <span class="highlight">${label}</span> (${score}%)`;

                        // SCAN TRIGGER: Matches your 100% accuracy labels
                        if (label !== "BACKGROUND" && top.value > 0.85) {
                            if (label !== lastItem) {
                                triggerScan(label);
                            }
                        }
                    }
                }
                requestAnimationFrame(processFrame);
            }
            video.onplay = processFrame;
        } catch (e) { 
            mainStatus.innerText = "CAMERA ERROR"; 
            console.error(e);
        }
    }

    function triggerScan(label) {
        isPaused = true;
        lastItem = label;
        
        // Visual Feedback
        const flash = document.getElementById('flash-effect');
        flash.style.opacity = "0.7";
        setTimeout(() => flash.style.opacity = "0", 100);

        // Add to history list
        const list = document.getElementById('item-list');
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        list.innerHTML = `<div class="item"><span>${label}</span><span>${time}</span></div>` + list.innerHTML;
        
        // Wait 3 seconds before next scan
        setTimeout(() => { isPaused = false; }, 3000);
    }

    window.onload = () => setTimeout(startApp, 1000);
</script>

