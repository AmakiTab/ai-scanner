<!DOCTYPE html>
<html>
<head>
    <title>Instant Product Scanner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="edge-impulse-standalone.js"></script>
    <script src="run-impulse.js"></script>
    <style>
        body { font-family: sans-serif; background: #000; color: white; text-align: center; margin: 0; }
        #camera { width: 100%; height: 50vh; object-fit: cover; border-bottom: 4px solid #4CAF50; }
        #status-bar { background: #222; padding: 15px; font-weight: bold; color: #fbff00; }
        #log { padding: 20px; text-align: left; background: #111; height: 40vh; overflow-y: auto; }
        .item { color: #4CAF50; padding: 10px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; }
        .flash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>
    <div id="flash-effect" class="flash"></div>
    <video id="camera" autoplay playsinline></video>
    <div id="status-bar"><span id="status-text">LOADING 100% ACCURACY MODEL...</span></div>
    
    <div id="log">
        <div style="color:#666">Scan History:</div>
        <div id="item-list"></div>
    </div>

    <canvas id="procCanvas" width="160" height="160" style="display:none;"></canvas>

    <script>
        let lastScanned = ""; 
        let cooldown = false;

        async function start() {
            const video = document.getElementById('camera');
            const status = document.getElementById('status-text');
            const canvas = document.getElementById('procCanvas');
            const ctx = canvas.getContext('2d');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;

                const classifier = new EdgeImpulseClassifier();
                await classifier.init();
                status.innerText = "READY: SCAN PRODUCT";

                async function loop() {
                    if (!cooldown) {
                        ctx.drawImage(video, 0, 0, 160, 160);
                        const data = ctx.getImageData(0, 0, 160, 160).data;
                        const pixels = [];
                        for (let i = 0; i < data.length; i += 4) {
                            pixels.push(data[i], data[i+1], data[i+2]);
                        }

                        const result = await classifier.classify(pixels);
                        
                        if (result.results && result.results.length > 0) {
                            let top = result.results.reduce((a, b) => a.value > b.value ? a : b);

                            // Only trigger if it's NOT background and confidence > 80%
                            if (top.label !== "BACKGROUND" && top.value > 0.80) {
                                if (top.label !== lastScanned) {
                                    triggerScan(top.label);
                                } else {
                                    status.innerText = `STILL SEEING: ${top.label}`;
                                }
                            } else if (top.label === "BACKGROUND") {
                                status.innerText = "WAITING FOR PRODUCT...";
                            }
                        }
                    }
                    requestAnimationFrame(loop);
                }
                video.onplay = loop;
            } catch (e) { status.innerText = "STARTUP ERROR: Check Camera Permissions"; }
        }

        function triggerScan(label) {
            cooldown = true;
            lastScanned = label;
            
            // Visual Flash
            const f = document.getElementById('flash-effect');
            f.style.opacity = "0.6";
            setTimeout(() => f.style.opacity = "0", 150);

            // Add to list
            const list = document.getElementById('item-list');
            list.innerHTML = `<div class="item"><span>${label}</span><span>RECORDED</span></div>` + list.innerHTML;
            document.getElementById('status-text').innerText = "SUCCESS: " + label;
            
            // 2 second pause so it doesn't scan too fast
            setTimeout(() => { cooldown = false; }, 2000);
        }

        window.onload = start;
    </script>
</body>
</html>
