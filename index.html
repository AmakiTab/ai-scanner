<!DOCTYPE html>
<html>
<head>
    <title>AI Product Face-ID</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="edge-impulse-standalone.js" defer></script>
<script src="run-impulse.js" defer></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #0b0b0b; color: white; text-align: center; margin: 0; overflow: hidden; }
        #camera { width: 100%; height: 50vh; object-fit: cover; border-bottom: 2px solid #4CAF50; }
        
        /* The Brain Monitor */
        #status-bar { background: #1a1a1a; padding: 15px; border-bottom: 1px solid #333; }
        #thinking-box { font-size: 0.8rem; color: #888; margin-top: 5px; font-family: monospace; }
        .highlight { color: #fbff00; font-weight: bold; }

        #log { padding: 20px; text-align: left; height: 40vh; overflow-y: auto; background: #000; }
        .scanned-item { 
            background: #1a1a1a; padding: 12px; border-radius: 8px; margin-bottom: 8px;
            display: flex; justify-content: space-between; border-left: 4px solid #4CAF50;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateX(-10px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .flash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; z-index: 100; transition: opacity 0.1s; }
    </style>
</head>
<body>
    <div id="flash-effect" class="flash"></div>
    <video id="camera" autoplay playsinline></video>
    
    <div id="status-bar">
        <div id="main-status" style="color: #4CAF50; font-weight: bold;">INITIALIZING AI...</div>
        <div id="thinking-box">AI BRAIN: <span id="brain-text">Waiting for camera...</span></div>
    </div>
    
    <div id="log">
        <div style="color:#555; font-size: 0.7rem; margin-bottom: 10px; letter-spacing: 1px;">RECORDED SESSIONS</div>
        <div id="item-list"></div>
    </div>

    <canvas id="hiddenCanvas" width="160" height="160" style="display:none;"></canvas>

    <script>
        let lastScannedItem = ""; 
        let cooldown = false;

        async function init() {
            const video = document.getElementById('camera');
            const mainStatus = document.getElementById('main-status');
            const brainText = document.getElementById('brain-text');
            const canvas = document.getElementById('hiddenCanvas');
            const ctx = canvas.getContext('2d');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;

                const classifier = new EdgeImpulseClassifier();
                await classifier.init();
                mainStatus.innerText = "READY: SCAN PRODUCT FACE";

                async function frameLoop() {
                    if (!cooldown) {
                        ctx.drawImage(video, 0, 0, 160, 160);
                        const imgData = ctx.getImageData(0, 0, 160, 160).data;
                        const pixels = [];
                        for (let i = 0; i < imgData.length; i += 4) {
                            pixels.push(imgData[i], imgData[i+1], imgData[i+2]);
                        }

                        const result = await classifier.classify(pixels);
                        
                        if (result.results && result.results.length > 0) {
                            // Sort to find what the AI is "thinking" most
                            let top = result.results.reduce((a, b) => a.value > b.value ? a : b);
                            let confidence = (top.value * 100).toFixed(1);
                            let label = top.label.toUpperCase();

                            // FEATURE: THE BRAIN MONITOR
                            brainText.innerHTML = `Seeing <span class="highlight">${label}</span> (${confidence}%)`;

                            // Trigger Logic
                            if (label !== "BACKGROUND" && top.value > 0.85) {
                                if (label !== lastScannedItem) {
                                    triggerScan(label);
                                }
                            }
                        }
                    }
                    requestAnimationFrame(frameLoop);
                }
                video.onplay = frameLoop;
            } catch (e) { mainStatus.innerText = "ERROR: ACCESS DENIED"; }
        }

        function triggerScan(label) {
            cooldown = true;
            lastScannedItem = label;
            
            // Visual Feedback
            const flash = document.getElementById('flash-effect');
            flash.style.opacity = "0.7";
            setTimeout(() => flash.style.opacity = "0", 100);

            // Record New Data
            const list = document.getElementById('item-list');
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            list.innerHTML = `
                <div class="scanned-item">
                    <span>${label}</span>
                    <span style="color: #666; font-size: 0.8rem;">${time}</span>
                </div>` + list.innerHTML;

            // Cooldown prevents double-scans
            setTimeout(() => { cooldown = false; }, 2000);
        }

        window.onload = init;
    </script>
</body>
</html>

