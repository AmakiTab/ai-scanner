<script src="edge-impulse-standalone.js"></script>
<script src="run-impulse.js"></script> <script>
    let totalCost = 0;
    let cooldown = false;
    const prices = {
        "Deodorant": 155.00,
        "Grips": 112.50,
        "Hot sauce": 94.00,
        "Power bank": 925.00
    };

    async function startScanner() {
        const video = document.getElementById('camera');
        const status = document.getElementById('status');

        try {
            // 1. Initialize Camera
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" } 
            });
            video.srcObject = stream;

            // 2. Initialize the AI Classifier from run-impulse.js
            const classifier = new EdgeImpulseClassifier();
            await classifier.init();
            status.innerText = "Model Ready - Point at item";

            // 3. The Processing Loop
            async function processFrame() {
                if (!cooldown) {
                    // This is a simplified capture; depending on your model, 
                    // you may need to draw the video to a canvas to get pixel data.
                    // For now, we attempt to classify the video element directly.
                    try {
                        const result = await classifier.classify(video);
                        
                        if (result.results && result.results.length > 0) {
                            // Find the label with the highest confidence
                            let top = result.results.reduce((prev, current) => 
                                (prev.value > current.value) ? prev : current
                            );

                            // Trigger if it's not Background and confidence > 0.20
                            if (top.label !== "Background" && top.value > 0.20) {
                                status.innerText = `Seeing: ${top.label} (${(top.value * 100).toFixed(0)}%)`;
                                if (prices[top.label]) {
                                    addItem(top.label);
                                }
                            }
                        }
                    } catch (e) {
                        // Some browsers require canvas processing before classification
                        console.error("Classification error:", e);
                    }
                }
                requestAnimationFrame(processFrame);
            }
            
            video.onloadeddata = () => {
                processFrame();
            };

        } catch (err) {
            status.innerText = "Error: Camera access denied.";
            console.error(err);
        }
    }

    function addItem(label) {
        if (cooldown) return;
        cooldown = true;
        
        totalCost += prices[label];
        const list = document.getElementById('item-list');
        list.innerHTML += `<div class="item"><span>${label}</span><span>P${prices[label].toFixed(2)}</span></div>`;
        document.getElementById('total').innerText = "Total: P" + totalCost.toFixed(2);
        document.getElementById('status').innerText = "Added " + label + "!";

        setTimeout(() => { 
            cooldown = false; 
            document.getElementById('status').innerText = "Scanning..."; 
        }, 3000);
    }

    window.onload = startScanner;
</script>
