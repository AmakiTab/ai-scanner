<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Product Scanner</title>
    <script src="edge-impulse-standalone.js"></script>
    <script src="run-impulse.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #000; color: #fff; margin: 0; overflow: hidden; text-align: center; }
        #camera { width: 100%; height: 60vh; object-fit: cover; }
        #status-bar { background: #222; padding: 20px; font-size: 1.2rem; font-weight: bold; color: #fbff00; border-bottom: 2px solid #444; }
        #log { height: 40vh; overflow-y: auto; background: #111; padding: 15px; text-align: left; }
        .scan-item { border-left: 4px solid #4CAF50; background: #222; margin-bottom: 10px; padding: 12px; display: flex; justify-content: space-between; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(-10px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .flash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; opacity: 0; pointer-events: none; z-index: 100; transition: opacity 0.1s; }
        .debug-text { font-size: 0.8rem; color: #888; margin-top: 5px; font-family: monospace; }
    </style>
</head>
<body>
    <div id="flash-effect" class="flash"></div>
    <video id="camera" autoplay playsinline></video>
    <div id="status-bar">
        <div id="main-status">INITIALIZING AI...</div>
        <div id="debug-info" class="debug-text">Waiting for camera...</div>
    </div>
    <div id="log">
        <div style="color: #666; font-size: 0.9rem; margin-bottom: 10px;">RECORDED SESSIONS:</div>
        <div id="item-list"></div>
    </div>
    <canvas id="hiddenCanvas" width="160" height="160" style="display:none;"></canvas>

<script>
    let lastScannedItem = "";
    let cooldown = false;

    async function init() {
        const video = document.getElementById('camera');
        const mainStatus = document.getElementById('main-status');
        const debugInfo = document.getElementById('debug-info');
        const canvas = document.getElementById('hiddenCanvas');
        const ctx = canvas.getContext('2d');

        try {
            // 1. Start Camera
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: 640, height: 640 } 
            });
            video.srcObject = stream;

            // 2. Load the 100% Accuracy Model
            const classifier = new EdgeImpulseClassifier();
            await classifier.init();
            
            mainStatus.innerText = "READY: SCAN LABEL";
            debugInfo.innerText = "Model: Classification (160x160)";

            // 3. The Recognition Loop
            async function frameLoop() {
                if (!cooldown) {
                    ctx.drawImage(video, 0, 0, 160, 160);
                    const imgData = ctx.getImageData(0, 0, 160, 160).data;
                    const pixels = [];
                    for (let i = 0; i < imgData.length; i += 4) {
                        pixels.push(imgData[i], imgData[i+1], imgData[i+2]);
                    }

                    const result = await classifier.classify(pixels);
                    
                    if (result.results && result.results.length > 0) {
                        let top = result.results.reduce((a, b) => a.value > b.value ? a : b);
                        
                        // Update Debugger
                        debugInfo.innerText = `Top Match: ${top.label} (${(top.value * 100).toFixed(1)}%)`;

                        // The Trigger Logic (Matches your exact labels)
                        const products = ["Deodorant", "Grips", "Hot sauce", "Power bank"];
                        
                        if (products.includes(top.label) && top.value > 0.85) {
                            if (top.label !== lastScannedItem) {
                                triggerSuccess(top.label);
                            } else {
                                mainStatus.innerText = "ALREADY RECORDED";
                                mainStatus.style.color = "#4CAF50";
                            }
                        } else if (top.label === "Background") {
                            mainStatus.innerText = "READY: SCAN LABEL";
                            mainStatus.style.color = "#fbff00";
                        }
                    }
                }
                requestAnimationFrame(frameLoop);
            }
            video.onplay = frameLoop;

        } catch (err) {
            mainStatus.innerText = "CAMERA ERROR";
            debugInfo.innerText = err.message;
        }
    }

    function triggerSuccess(label) {
        cooldown = true;
        lastScannedItem = label;

        // Visual Flash Feedback
        const flash = document.getElementById('flash-effect');
        flash.style.opacity = "1";
        setTimeout(() => { flash.style.opacity = "0"; }, 100);

        // Update Log (Recording only new data)
        const list = document.getElementById('item-list');
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        list.innerHTML = `
            <div class="scan-item">
                <span><strong>${label}</strong></span>
                <span style="color: #888;">${time}</span>
            </div>` + list.innerHTML;

        document.getElementById('main-status').innerText = "RECORDED: " + label.toUpperCase();

        // 2 Second pause to prevent accidental double-scans
        setTimeout(() => { cooldown = false; }, 2000);
    }

    window.onload = init;
</script>
</body>
</html>
